name: Build macOS App

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # ÂÖÅË®±ÊâãÂãïËß∏Áôº

jobs:
  build-macos:
    runs-on: macos-latest
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
    
    - name: üêç Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: üì¶ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller playwright pandas openpyxl
        
    - name: üé≠ Install Playwright browsers
      run: |
        python -m playwright install chromium
        python -m playwright install-deps chromium
    
    - name: üî® Build with PyInstaller
      run: |
        pyinstaller --name "BookingSearchTool" \
          --onefile \
          --windowed \
          --add-data "$(python -c 'import playwright; print(playwright.__path__[0])'):playwright" \
          --hidden-import playwright \
          --hidden-import playwright.sync_api \
          --hidden-import pandas \
          --hidden-import openpyxl \
          --osx-bundle-identifier "com.booking.searchtool" \
          booking_search.py
    
    - name: üì± Create .app bundle
      run: |
        # Âª∫Á´ã .app ÁµêÊßã
        APP_NAME="BookingSearchTool"
        APP_DIR="dist/${APP_NAME}.app"
        CONTENTS_DIR="${APP_DIR}/Contents"
        MACOS_DIR="${CONTENTS_DIR}/MacOS"
        RESOURCES_DIR="${CONTENTS_DIR}/Resources"
        
        mkdir -p "${MACOS_DIR}"
        mkdir -p "${RESOURCES_DIR}"
        
        # ÁßªÂãïÂü∑Ë°åÊ™î
        mv "dist/${APP_NAME}" "${MACOS_DIR}/${APP_NAME}"
        chmod +x "${MACOS_DIR}/${APP_NAME}"
        
        # Âª∫Á´ã Info.plist
        cat > "${CONTENTS_DIR}/Info.plist" << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>CFBundleName</key>
            <string>BookingSearchTool</string>
            <key>CFBundleDisplayName</key>
            <string>Booking ÊêúÂ∞ãÂ∑•ÂÖ∑</string>
            <key>CFBundleIdentifier</key>
            <string>com.booking.searchtool</string>
            <key>CFBundleVersion</key>
            <string>1.0.0</string>
            <key>CFBundleShortVersionString</key>
            <string>1.0.0</string>
            <key>CFBundleExecutable</key>
            <string>BookingSearchTool</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
            <key>LSMinimumSystemVersion</key>
            <string>10.15</string>
            <key>NSHighResolutionCapable</key>
            <true/>
            <key>LSApplicationCategoryType</key>
            <string>public.app-category.utilities</string>
        </dict>
        </plist>
        EOF
        
        echo "‚úÖ .app bundle created: ${APP_DIR}"
        ls -la dist/
    
    - name: üì¶ Create .pkg installer
      run: |
        APP_NAME="BookingSearchTool"
        VERSION="1.0.0"
        
        # Âª∫Á´ãÊö´Â≠òÁõÆÈåÑ
        mkdir -p pkg_root/Applications
        cp -R "dist/${APP_NAME}.app" pkg_root/Applications/
        
        # Âª∫Á´ã .pkg
        pkgbuild --root pkg_root \
                 --identifier "com.booking.searchtool" \
                 --version "${VERSION}" \
                 --install-location "/" \
                 "${APP_NAME}_${VERSION}.pkg"
        
        echo "‚úÖ .pkg created: ${APP_NAME}_${VERSION}.pkg"
        ls -la *.pkg
    
    - name: üì§ Upload .app artifact
      uses: actions/upload-artifact@v4
      with:
        name: BookingSearchTool-macOS-app
        path: dist/BookingSearchTool.app
        retention-days: 30
    
    - name: üì§ Upload .pkg artifact
      uses: actions/upload-artifact@v4
      with:
        name: BookingSearchTool-macOS-pkg
        path: "*.pkg"
        retention-days: 30
    
    - name: üè∑Ô∏è Create Release (on tag push)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          BookingSearchTool_*.pkg
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
